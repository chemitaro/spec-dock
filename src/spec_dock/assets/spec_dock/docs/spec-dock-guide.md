# .spec-dock ディレクトリガイド

## 目的（Codex CLI が迷わない状態）
このガイドは、AI エージェント（Codex CLI）が「推測で進めない」「詰まらない」状態を作るための運用ルールです。

- 要件が **観測可能な振る舞い（AC/EC）** まで落ちており、スコープ境界（MUST/MUST NOT/OUT OF SCOPE）が明文化されている
- 設計が「どのファイルをどう変えるか」「どの IF を固定するか」「どのテストで担保するか」まで具体化され、要件→設計→テストのトレーサビリティがある
- 実装計画が「1ステップ=1つの観測可能な振る舞い」で、各ステップで Red/Green/Refactor を回せる粒度になっている
- 実装中の事実（実行コマンド/結果/変更ファイル/判断の経緯/コミット）がセッション単位で残り、後から再現できる
- “誰が何をするか（AI/人間）” が運用ルールとして固定され、権限や禁止操作と矛盾しない

## コア原則

I. **95%理解ルール（絶対厳守）**  
常に「95%以上理解できている／95%以上の確信が持てている」状態になるまで要件定義・設計・実装に進まないこと。  
コードベースの構造、依存関係、ビジネスロジック、影響範囲、現状仕様を把握し、必要なら調査ツールも使って情報を集める。  
理解が不足している場合は、まず自力で調査したうえで、なお不明な点だけを整理してユーザー/レビュアーに質問してから進める。

II. **テスト駆動開発（TDD）**  
Kent Beck と 和田卓人 (t-wada) の Red → Green → Refactor サイクルに従って開発する。  
失敗する自動テスト（Red）なしに本番コード（機能コード）を書かないこと。  
小さなステップで進み、具体例から一般化する形でテストと実装を育てる。

## 成果物とディレクトリ

- `.spec-dock/spec-dock.version`
  - 導入/更新した spec-dock のバージョン（1行）
- `.spec-dock/current/`
  - 作業中の一時ディレクトリ（1つの作業単位を前提。混在させない）
  - `requirement.md`: 要件定義（WHAT/WHY）
  - `design.md`: 設計（HOW）
  - `plan.md`: 実装計画（TDD で回せる粒度）
  - `report.md`: 実装ログ（再現できる事実）
  - `discussions/`: 議論/調査/ヒアリング等の補助資料置き場（原則Markdown。図はPlantUML。サブディレクトリ作成も含め自由）
- `.spec-dock/templates/`
  - テンプレート（新規タスク開始時の雛形）
  - `discussions/`: 議論/調査/ヒアリング資料の雛形置き場（例: `discussions/_template.md`。必要に応じて増やしてよい）
- `.spec-dock/completed/`
  - 完了した成果物のアーカイブ

## テンプレート方針
- `.spec-dock/templates/requirement.md` / `design.md` / `plan.md` / `report.md` は「最終的に残る仕様/ログ」の雛形とし、原則として本文に運用ルールや作成手順を書かない（ルールはこの `spec-dock-guide.md` に集約する）。
- `discussions/_template.md` は「議論/調査/ヒアリング」資料の雛形。運用ルールはこのガイドを正としつつ、テンプレ内に最低限の説明を書いてよい。
- テンプレートは **参考**。見出し/順番/粒度はタスクに合わせて自由に追加/削除/並び替えしてよい（“空欄を埋めるための推測”は禁止）。承認可否はこのガイドのチェックリストで判定する。
- テンプレ見出しの末尾に `(必須)` / `(任意)` を付ける。`(必須)` は成果物（`.spec-dock/current/*.md`）から削除しない（該当しない場合は `該当なし` を明記）。`(任意)` は削除/追加してよい。
  - 付与対象: 主に `##` 見出し。必要に応じて `###`/`####` 見出しにも付けてよい（例: `plan.md` の各ステップ内の `update_plan` / `期待する振る舞い` / `ステップ末尾`）。
- 例外: `plan.md` は実装時に省略されやすい `update_plan` / テスト / `report.md` 記録 / コミットのチェックを **各ステップ内に必ず残す**（実装フェーズの抜け漏れ防止のため）。
- 実装フェーズでは `.spec-dock/current/{requirement,design,plan}.md` を仕様として読み、運用確認が必要な時だけこのガイドを参照する。

## 用語・状態・役割分担

- `状態: draft | approved` の `approved`
  - ユーザー/レビュアーの **明示的な承認** を指す（チェックリストを満たしても自動では `approved` にならない）。
- `update_plan`（Codex CLI）
  - 各ステップ内の作業ステップ（調査/Red/Green/Refactor/品質ゲート/コミット等）を管理するための機能。
- ドキュメントの正（source of truth）
  - **IF契約 / 変更計画 / 要件→設計→テストのマッピング** は `design.md` を正とする（`plan.md` は実装順序とステップの最小差分を書く）。
- ID運用
  - `AC-xxx / EC-xxx / API-xxx / IF-xxx / MODEL-xxx / R-xxx / Q-xxx / Sxx` は承認後に再採番/リネームしない（追加は末尾に足す）。
- Git 運用
  - 実装フェーズのコミット（`git commit`）は **エージェントが実施** する。
  - コミットは原則「`plan.md` の各ステップ末尾（品質ゲート通過後）」でのみ実施する（むやみにコミットしない）。例外が必要なら `report.md` に理由を残す。
  - 破壊的・不可逆になり得る Git/GitHub 操作（例: 履歴書き換え、強制更新、削除、権限/設定変更など）は、実行前に「何を・どこに・なぜ」を説明し、ユーザーの明示的確認を取る。

## ルール集約（テンプレに書かない）

### 共通

- 不明点は推測しない。TBD として「質問/選択肢/推奨案/影響範囲」を明記する。
- 「未確定事項（TBD）」は **必須**。未確定事項が無いことも重要な情報なので、無い場合は `該当なし` を明記する。
- ID（AC/EC/API/IF/MODEL/R/Q/Sxx）は承認後に再採番しない（追加は末尾）。
- 省略/例外がある場合は、各ドキュメント末尾の「省略/例外メモ」に理由と影響範囲を記録する（該当が無い場合は `該当なし` と書く）。

### `requirement.md`（WHAT/WHY）

- WHAT/WHY のみを書く（ライブラリ/DB設計/API設計/ディレクトリ構成などのHOWは `design.md` へ）。
- As-Is は「観測結果＋根拠」で固定する（例: 再現手順、観測点（UI/HTTP/DB/Log）、実際の出力、根拠コード（パス＋関数/クラス＋行番号））。
- 観測点（DB/Log 等）は「どこを見るか」の宣言に留め、スキーマ設計やログ設計などのHOWは `design.md` に書く。
- AC/EC はテストに落ちる粒度で書く（Actor/Role、観測点、権限/認可条件、入力→出力例）。
- 判断材料/トレードオフは要件/仕様レベルに限定する（技術選定/実装方式は `design.md` へ）。

### `design.md`（HOW）

- HOW（設計の決定事項）を書く。要件変更が必要なら `requirement.md` へ差し戻す。
- `design.md` を正（source of truth）とし、IF契約/変更計画/マッピングをここに集約する。
- テンプレの各セクションは、タスクに不要なら **削除/省略/追加してよい**（推測で埋めて “それっぽい設計” を捏造しない）。承認可否はチェックリストで判定する。
- インターフェース契約（API/関数・クラス境界）は、追加/変更がある場合にのみ固定する。該当が無い場合は省略してよい（推測で新規に定義しない）。
- 主要フローは、複数AC/複数コンポーネント/外部連携/状態遷移など、順序や分岐が重要な場合に記載する。単純な変更で不要なら省略してよい（省略理由は「省略/例外メモ」に残す）。
- 「既存実装/規約の調査結果（As-Is / 95%理解）」に、参照だけでなく観測した事実と採用パターン（採用しない理由含む）を残す。
- UML は PlantUML を使う。テンプレは例を豊富に置くが、成果物では必要な図だけ残す（不要な図サブセクションは削除/省略する）。
- （任意）「ディレクトリ/ファイル構成図」は `tree` 風（`├──` / `│` / `└──`）で、変更点が追える最小範囲にする（入れる場合は変更計画と整合させる）。複数モジュール/複数層に跨る、または変更対象ファイルが多い場合は記載を推奨する。省略する場合は「省略/例外メモ」に代替情報（例: 変更ファイル数、主要ディレクトリ、跨ぎ変更の有無）を残す。
- テスト戦略は、**コード変更がある場合は原則記載する**（追加/修正するテスト、または既存テストで担保する箇所の参照）。ドキュメントのみ等、コード変更が無い場合のみ省略してよい（省略時は「省略/例外メモ」に理由を残す）。

### `plan.md`（実装計画）

- `plan.md` は実装順序と「1ステップ=1つの観測可能な振る舞い」を定義する（作業内容の羅列ではなく、テストで観測できる形）。
- IF/変更対象ファイルの全体一覧やマッピングは `design.md` が正。`plan.md` にはステップ単位の参照と最小差分を書く。
- 実装ステップ（Sxx）は繰り返しブロックとして必要数だけ追加する（テンプレの S01 ステップブロックを複製し、S02/S03…として追加する。追加したステップでも (必須) のサブセクションは省略しない）。少なくとも1ステップは必須。
- 各ステップに「期待する振る舞い（テストケース）」を必ず書く（Given/When/Then、または入力→出力）。
- 各ステップ開始時に `update_plan` に作業ステップ（調査/Red/Green/Refactor/品質ゲート/コミット等）を登録し、作業中に更新する。
- `plan.md` の各ステップには「ステップ末尾（テスト/`report.md`/`update_plan` 更新/コミット）」のチェックを **必ず残す**（省略しない）。
- 仕様変更/追加対応が発生した場合は、コード着手前に `requirement.md` / `design.md` / `plan.md` を更新する。

### `report.md`（実装ログ）

- セッション単位で、開始/終了時刻・対象ステップ・実行コマンド・結果・変更ファイル・コミット（hash/message）を記録する（失敗も残す）。
- ここには事実ログを書く（設計変更が必要なら上流ドキュメントへ差し戻して整合を取る）。

## チェックリスト（抜け漏れ防止）

### `requirement.md` チェックリスト（承認依頼前）
- [ ] 目的（To-Be）が1〜3行で明確
- [ ] As-Is が「再現手順/観測点/実際の観測結果/根拠（コードは行番号まで）」で書かれている
- [ ] スコープ（MUST / MUST NOT / OUT OF SCOPE）が明文化されている
- [ ] 非交渉制約・前提が明文化されている
- [ ] AC が観測可能（テスト可能）で、Actor/Role・観測点・権限/認可条件がある
- [ ] EC が条件/期待/観測点で固定されている
- [ ] TBD が「質問/選択肢/推奨案/影響範囲」になっている
- [ ] 重要な用語（ドメイン語彙）が定義されている
- [ ] 「省略/例外メモ」が `該当なし` または理由/影響範囲つきで記載されている

### `design.md` チェックリスト（承認依頼前）
- [ ] `design.md` を正（source of truth）として、IF契約/変更計画/マッピングが集約されている
- [ ] 「既存実装/規約の調査結果」に観測した事実と採用/不採用パターンがある
- [ ] （必要な場合）主要フローが AC 単位で整理されている（不要なら省略理由がある）
- [ ] （追加/変更がある場合）インターフェース契約（API/関数・クラス）が固定されている（該当が無い場合は省略理由がある）
- [ ] 変更計画がリポジトリ相対パスで具体化されている
- [ ] 要件→設計→テストのマッピングがある
- [ ] （コード/テスト変更がある場合）テスト戦略に AC/EC→テストの対応と、非交渉制約の検証方法がある（変更が無い場合は理由がある）
- [ ] UML は必要な図だけ残している（不要な図サブセクションは削除/省略）
- [ ] TBD が「質問/選択肢/推奨案/影響範囲」になっている
- [ ] 「省略/例外メモ」が `該当なし` または理由/影響範囲つきで記載されている

### `plan.md` チェックリスト（承認依頼前）
- [ ] 対象AC/EC/制約が明記されている
- [ ] 要件 ↔ ステップ対応表があり、対象AC/ECをすべてカバーしている
- [ ] 実装ステップが少なくとも1つある
- [ ] 各ステップが「1ステップ=1つの観測可能な振る舞い」になっている
- [ ] 各ステップに Given/When/Then（または入力→出力）がある
- [ ] 各ステップに `design.md` 参照（対象IF/API/テスト）がある
- [ ] 各ステップに `update_plan`（着手時に登録）セクションがあり、削除していない
- [ ] 各ステップに「ステップ末尾（テスト/`report.md`/`update_plan` 更新/コミット）」があり、削除していない
- [ ] TBD が「質問/選択肢/推奨案/影響範囲」になっている
- [ ] 「省略/例外メモ」が `該当なし` または理由/影響範囲つきで記載されている

### `report.md` チェックリスト（セッション記録の抜け漏れ防止）
- [ ] 開始/終了時刻がある
- [ ] 対象ステップ（Sxx）と AC/EC がある
- [ ] 実行コマンドと結果（失敗も含む）がある
- [ ] 変更ファイルが列挙されている
- [ ] コミット（hash/message）がある
- [ ] 「省略/例外メモ」が `該当なし` または理由/影響範囲つきで記載されている

## ワークフロー

### 計画フェーズ（Planning Phase）

1. **要件定義（`.spec-dock/current/requirement.md`）**
   - AC/EC を観測可能（テスト可能）な形に落とす
   - MUST/MUST NOT/OUT OF SCOPE を明文化してスコープ境界を固定する
   - As-Is は観測結果（再現手順/観測点/実際の出力）と根拠（コード/ログ等）を残す
   - **承認ゲート（必須）**: ユーザー/レビュアーに提出し、承認（`approved`）を得るまで設計へ進まない

2. **設計（`.spec-dock/current/design.md`）**
   - 変更計画（パス単位）/固定する IF / 影響範囲 / テスト戦略を具体化する
   - コーディング規約と同レイヤー既存実装を調査し、スタイルやパターン（命名/責務/例外処理など）を設計に反映する
   - UML 図は PlantUML で記述する（Markdown のコードブロック言語は `plantuml`）
   - UML 図は必要最小限（成果物では、適した図だけ残し、不要な図は削除）
   - **承認ゲート（必須）**: ユーザー/レビュアーに提出し、承認（`approved`）を得るまで実装計画へ進まない

3. **実装計画（`.spec-dock/current/plan.md`）**
   - 1ステップ=1つの観測可能な振る舞い（テストで観測できる）で分割する
   - 各ステップで Red/Green/Refactor を回せる粒度にする
   - 各ステップに「達成する振る舞い（= テストケース）」を言語化して定義する
   - **承認ゲート（必須）**: ユーザー/レビュアーに提出し、承認（`approved`）を得るまで実装へ進まない

### 実装フェーズ（Implementation Phase）

1. `plan.md` から着手するステップ（Sxx/Phase）を選ぶ
   - 追加/修正作業が発生した場合は、**コード着手前** に `requirement.md` / `design.md` / `plan.md` を更新する
   - `plan.md` の完了済みステップ（チェック済み）は上書き修正しない。修正作業は新しいステップとして追加する
   - 着手ステップの作業ステップを `update_plan` に登録してから進める

2. 各ステップを TDD（Red → Green → Refactor）で実装する

3. ステップ/Phase を完了とみなす前に必ず行う
   - フォーマット/静的解析/テスト（必要なもの）を実行し、成功させる
   - コーディング規約（プロジェクト全体 + 対象レイヤー別）を参照してセルフレビューする
   - `plan.md` / `report.md` を更新する（実行コマンド/結果/変更ファイル/判断の経緯も含める）
   - **エージェントが `git commit` する**（原則: ステップ末尾。pre-commit 等で拒否された場合は原因を解消してコミットが通るまで繰り返す）

4. 実装中に知見や仕様変更が発生した場合は、`requirement.md` → `design.md` → `plan.md` → `report.md` の順で差分を反映し、矛盾を残さない

## ベストプラクティス

- ドキュメント本文は日本語で記述しつつ、ファイル名・ディレクトリ名は英語のまま維持する  
- 関連する成果物は `@.spec-dock/...` 形式で相互参照し、要件・設計・計画・実装ログ・コードをトレーサブルに保つ  
- 重要な意思決定・未解決の論点・ブロッカーは `report.md` に明記し、人間のレビューや相談につなげる  
- 要件・設計・plan・report の内容は、最終的に作成される Pull Request の説明やレビューでの議論と整合するように維持する  
